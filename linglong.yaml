version: '1'
package:
  id: org.freecad
  name: FreeCAD
  version: 1.0.2.0
  kind: app
  description: 'FreeCAD是用于CAD，MCAD，CAx，CAE和PLM的基于功能的通用型参数3D建模器，直接针对机械工程和产品设计，但也适用于工程学中的广泛用途，例如建筑或其他工程专业。它是100％开放源代码和高度模块化的，允许进行非常高级的扩展和定制。

    '
base: org.deepin.base/25.2.1
command:
- /opt/apps/org.freecad/files/bin/org.freecad
build: |
  cd /project/linglong/sources
  APPIMAGE=$(find . -regex '.*\.AppImage\|.*appimage' -exec basename {} \; | grep -E 'x86_64|amd64' | head -1)
  if [ -z "$APPIMAGE" ]; then
    APPIMAGE=$(find . -regex '.*\.AppImage\|.*appimage' -exec basename {} \; | head -1)
  fi
  echo "$APPIMAGE"
  chmod +x ${APPIMAGE}
  ./${APPIMAGE} --appimage-extract
  BINNAME=${LINGLONG_APPID}
  APP_PREFIX=${BINNAME}
  echo "#!/usr/bin/env bash" > ${BINNAME}
  echo "unset LD_LIBRARY_PATH" >> ${BINNAME}
  echo "cd ${PREFIX}/lib/${APP_PREFIX} && ./AppRun $@" >> ${BINNAME}
  # only search for .desktop file in the squashfs-root directory
  DESKTOP_FILE=$(find squashfs-root -maxdepth 1 -regex '.*\.desktop' -exec basename {} \;)
  cp squashfs-root/${DESKTOP_FILE} .
  sed -i "s@Exec=.*@Exec=${PREFIX}/bin/${BINNAME}@" ${DESKTOP_FILE}
  cd squashfs-root
  if [ ! $PREFIX ]; then
    PREFIX=opt/${APP_PREFIX}
  fi
  DESTDIR=${dest_dir}
  # install icons to linglong package
  if [ -d usr/share/icons ]; then
    cd usr
    find share/icons -type f -exec install -D "{}" "${DESTDIR}/${PREFIX}/{}" \;
    cd ..
  fi
  find -type d -exec install -d "${DESTDIR}/${PREFIX}/lib/${APP_PREFIX}/{}" \;
  find -type f -exec install -D "{}" "${DESTDIR}/${PREFIX}/lib/${APP_PREFIX}/{}" \;
  find -type l -exec bash -c "ln -s \$(readlink {}) "${DESTDIR}/${PREFIX}/lib/${APP_PREFIX}/{}" " -exec install -D "{}" "${DESTDIR}/${PREFIX}/lib/${APP_PREFIX}/{}" \;
  cd ..
  install -D ${BINNAME} ${DESTDIR}/${PREFIX}/bin/${BINNAME}
  install -D ${DESKTOP_FILE} ${DESTDIR}/${PREFIX}/share/applications/${DESKTOP_FILE}
  rm -rf squashfs-root

sources:
- kind: file
  url: https://edgeone.gh-proxy.com/https://github.com/FreeCAD/FreeCAD/releases/download/1.0.2/FreeCAD_1.0.2-conda-Linux-x86_64-py311.AppImage
  digest: e00be00ad9fdb12b05c5002bfd1aa2ea8126f2c1d4e2fb603eb7423b72904f61
  name: FreeCAD-1.0.2-conda-Linux-x86_64-py311.AppImage
